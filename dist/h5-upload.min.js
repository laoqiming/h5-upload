$.fn.extend({h5upload:function(e){function a(e){e.height(e.width()),$(":file",e).width(e.width()).height(e.height())}function t(e){1==$(".h5-upload-remove",e).length&&$(".h5-upload-remove",e).hide()}function i(e){if($(".h5-upload-item",e).length<s.max){if(0==$(".h5-upload-item-add",e).length){var i=$('<div class="h5-upload-item-add h5-upload-item">                            <input type="file" class="h5-upload-control" name="'+s.uploadFieldName+'">                            <img src="'+s.btnAdd+'" class="h5-upload-preview">                            <input type="hidden" name="'+s.formFieldName+'" class="h5-upload-field" value="">                            <span class="h5-upload-remove"><img src="'+s.btnRemove+'"></span>                            <div class="h5-upload-error"></div>                            <div class="h5-upload-progressbar">                                <span></span>                            </div>                        </div>').appendTo(e);setTimeout(function(){a(i)},100)}}else $(".h5-upload-item-add",e).remove();t(e)}function d(e,a,t){a&&(a=Math.min(Math.max(a,0),100));var i=e.get(0).querySelector("span");if(i){e.show();var d=i.style;d.webkitTransform="translate3d("+(-100+a)+"%,0,0)",d.webkitTransitionDuration=void 0!==t?t+"ms":""}return e}function o(e,a){var t=new FileReader;t.readAsDataURL(e),t.onload=function(t){var i=new Image;i.src=t.target.result,i.onload=function(){var t=1;if(this.width>s.maxWidth&&(t=s.maxWidth/this.width),this.height>s.maxHeight&&(t=s.maxHeight/this.height),1==t)a&&a(e);else{var d=document.createElement("canvas");d.width=this.width*t,d.height=this.height*t,d.getContext("2d").drawImage(i,0,0,this.width,this.height,0,0,d.width,d.height);for(var o=d.toDataURL("image/jpeg",.8),n=window.atob(o.split(",")[1]),h=new ArrayBuffer(n.length),l=new Uint8Array(h),r=0;r<n.length;r++)l[r]=n.charCodeAt(r);var p,u=window.WebKitBlobBuilder||window.MozBlobBuilder;if(u){var m=new u;m.append(h),p=m.getBlob("image/jpeg")}else p=new window.Blob([h],{type:"image/jpeg"});a&&a(p)}}}}function n(e,a){var t=new FormData;t.append(s.uploadFieldName,e);var i=new XMLHttpRequest;i.upload.addEventListener("progress",a.progress,!1),i.addEventListener("load",a.load,!1),i.addEventListener("error",a.fail,!1),i.addEventListener("abort",a.cancel,!1),i.open("POST",s.server),i.send(t)}var s={server:"/Upload/UploadImage",btnAdd:"images/image-add.png",btnRemove:"images/remove.png",max:1,maxWidth:800,maxHeight:800,uploadFieldName:"imageUrl",formFieldName:"image",data:[]};return $.extend(s,e),$(this).each(function(){var e=$(this);$(s.data).each(function(){$('<div class="h5-upload-item">                        <input type="file" class="h5-upload-control">                        <img src="'+this+'" class="h5-upload-preview">                        <input type="hidden" name="'+s.formFieldName+'" class="h5-upload-field" value="'+this+'">                        <span class="h5-upload-remove"><img src="'+s.btnRemove+'"></span>                        <div class="h5-upload-error"></div>                        <div class="h5-upload-progressbar">                            <span></span>                        </div>                    </div>').appendTo(e)}),e.on("change","[type=file]",function(){var a=this,t=$(a).closest(".h5-upload-item"),s=t.find(".h5-upload-field"),h=t.find(".h5-upload-preview"),l=t.find(".h5-upload-progressbar"),r=t.find(".h5-upload-remove"),p=t.find(".h5-upload-error");if(p.hide(),l.hide(),a&&a.files&&a.files[0]){var u=a.files[0],m=u;o(u,function(a){m=a;var o=window.URL||window.webkitURL;h.prop("src",o.createObjectURL(m)),r.show(),t.hasClass("h5-upload-item-add")&&t.removeClass("h5-upload-item-add"),i(e),d(l,0),p.hide(),n(m,{progress:function(e){e.lengthComputable&&d(l,Math.round(e.loaded/e.total*100))},load:function(e){if(200==e.target.status)try{var a=JSON.parse(e.target.responseText);a.success?s.length>0&&s.val(a.url):(p.show().text(a.message),l.hide())}catch(e){p.show().text("上传失败！"),l.hide()}else p.show().text("上传失败！"),l.hide()},fail:function(e){p.show().text("上传失败！"),l.hide()},cancel:function(){p.show().text("上传被取消！"),l.hide()}})})}}),e.on("click",".h5-upload-remove",function(){$(this).closest(".h5-upload-item").remove(),i(e)}),$(".h5-upload-item",e).each(function(){$(".h5-upload-remove",this).show(),a($(this))}),i(e)})}});